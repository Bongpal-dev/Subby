rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 인증 필수
    function isAuthenticated() {
      return request.auth != null;
    }

    // 현재 사용자 ID
    function currentUserId() {
      return request.auth.uid;
    }

    // 그룹 멤버 여부 확인
    function isGroupMember(groupData) {
      return currentUserId() in groupData.members;
    }

    // 그룹장 여부 확인
    function isGroupOwner(groupData) {
      return groupData.ownerId == currentUserId();
    }

    // ──────────────────────────────────────────────
    // groups 컬렉션
    // ──────────────────────────────────────────────
    match /groups/{groupCode} {
      // 읽기: 그룹 멤버만
      allow read: if isAuthenticated() && isGroupMember(resource.data);

      // 생성: 인증된 사용자, 본인이 멤버에 포함되어야 함
      allow create: if isAuthenticated()
        && request.resource.data.ownerId == currentUserId()
        && currentUserId() in request.resource.data.members;

      // 수정: 그룹 멤버만 (이름 변경 등)
      // 단, ownerId 변경은 현재 그룹장만 가능
      allow update: if isAuthenticated()
        && isGroupMember(resource.data)
        && (
          // ownerId 변경 없음
          request.resource.data.ownerId == resource.data.ownerId
          // 또는 현재 그룹장이 변경
          || isGroupOwner(resource.data)
        );

      // 삭제: 그룹장만, 멤버가 본인만 남은 경우
      allow delete: if isAuthenticated()
        && isGroupOwner(resource.data)
        && resource.data.members.size() == 1;

      // ──────────────────────────────────────────────
      // subscriptions 서브컬렉션
      // ──────────────────────────────────────────────
      match /subscriptions/{subscriptionId} {
        // 읽기/쓰기: 그룹 멤버만
        allow read, write: if isAuthenticated()
          && isGroupMember(get(/databases/$(database)/documents/groups/$(groupCode)).data);
      }
    }

    // ──────────────────────────────────────────────
    // 기본 거부
    // ──────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
